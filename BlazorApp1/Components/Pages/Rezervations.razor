@page "/reservations"
@using BlazorApp1.DTO
@using BlazorApp1.DTO.Event
@rendermode InteractiveServer
@inject HttpClient Http

<h3>Rezervacijos</h3>

<div style="display:flex; gap:16px; flex-wrap:wrap; align-items:end;">
    <div>
        <label>Salė</label><br />
        <select @onchange="OnHallChanged">
            <option value="">-- pasirinkti --</option>
            @foreach (var h in halls)
            {
                <option value="@h.HallId">@h.Name</option>
            }
        </select>
    </div>

    <div>
        <label>Renginys</label><br />
        <select @onchange="OnEventChanged" disabled="@(selectedHallId is null)">
            <option value="">-- pasirinkti --</option>
            @foreach (var e in events)
            {
                <option value="@e.Id">@e.Name (@e.StartsAt.ToString("yyyy-MM-dd HH:mm"))</option>
            }
        </select>
    </div>

    <button type="button" @onclick="Reserve" disabled="@(selectedEventId is null || selectedSeatIds.Count == 0)">
        Rezervuoti (@selectedSeatIds.Count)
    </button>
</div>

@if (selectedEventId is not null)
{
    <hr />
    <h4>Laisvos vietos / užimtos</h4>

    @if (seats.Count == 0)
    {
        <p>Nėra vietų.</p>
    }
    else
    {
        <div style="margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:10px; max-width:720px;">
            <h4>Vietos paieška</h4>

            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
                <div>
                    <label>HallGroup</label><br />
                    <select @onchange="OnGroupSearchChanged" disabled="@(groupOptions.Count == 0)">
                        <option value="">-- visi --</option>
                        @foreach (var g in groupOptions)
                        {
                            <option value="@g" selected="@(g == selectedSearchGroup)">@g</option>
                        }
                    </select>
                </div>

                <div>
                    <label>Seat row</label><br />
                    <input type="number" style="width:120px;"
                           value="@(searchSeatRow?.ToString() ?? "")"
                           @oninput="OnRowSearchChanged"
                           placeholder="pvz 5" />
                </div>

                <div>
                    <label>Seat number</label><br />
                    <input type="number" style="width:140px;"
                           value="@(searchSeatNumber?.ToString() ?? "")"
                           @oninput="OnNumberSearchChanged"
                           placeholder="pvz 12" />
                </div>

                <button type="button" @onclick="ClearSearch" style="height:32px;">
                    Clear
                </button>
            </div>

            @if (filteredSeats.Count > 0)
            {
                <p style="margin-top:10px; font-weight:600;">
                    Rasta: @filteredSeats.Count vietų (rodoma lentelėje žemiau)
                </p>
            }
            else if (IsSearchActive)
            {
                <p style="margin-top:10px; font-weight:600; color:red;">
                    Pagal pasirinktus kriterijus vietų nerasta.
                </p>
            }
        </div>


        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="text-align:left; border-bottom:1px solid #ccc;">
                    <th style="padding:6px;">Rezervuoti</th>
                    <th style="padding:6px;">Grupė</th>
                    <th style="padding:6px;">HallSeatId</th>
                    <th style="padding:6px;">ShowSeatId</th>
                    <th style="padding:6px;">Color</th>
                    <th style="padding:6px;">Statusas</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in filteredSeats.OrderBy(x => x.GroupName).ThenBy(x => x.SeatRow).ThenBy(x => x.SeatNumber))

                {
                    var disabled = s.IsReserved;
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:6px;">
                            <input type="checkbox"
                                   disabled="@disabled"
                                   checked="@selectedSeatIds.Contains(s.HallSeatId)"
                                   @onchange="e => ToggleSeat(s.HallSeatId, (bool)e.Value!)" />
                        </td>
                        <td style="padding:6px;">@s.GroupName</td>
                        <td style="padding:6px;">@s.HallSeatId</td>
                        <td style="padding:6px;">@s.ShowSeatId</td>
                        <td style="padding:6px;">@s.Color</td>
                        <td style="padding:6px;">@(s.IsReserved ? "Užimta" : "Laisva")</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (!string.IsNullOrWhiteSpace(message))
    {
        <p style="margin-top:10px;">@message</p>
    }
}

@code {
    // čia naudok tavo jau turimą HallDto
    private List<HallDto> halls = new();
    private List<EventDto> events = new();
    private List<EventSeatDto> seats = new();

    private int? selectedHallId;
    private int? selectedEventId;

    private string? seatSearch;
    private string? searchResult;
    private bool searchOk;

    private List<string> groupOptions = new();
    private string? selectedSearchGroup;
    private int? searchSeatRow;
    private int? searchSeatNumber;

    private List<EventSeatDto> filteredSeats = new();

    private bool IsSearchActive =>
        !string.IsNullOrWhiteSpace(selectedSearchGroup) ||
        searchSeatRow is not null ||
        searchSeatNumber is not null;


    private HashSet<int> selectedSeatIds = new();
    private string? message;

    private string? SeatSearch
    {
        get => seatSearch;
        set
        {
            seatSearch = value;
            EvaluateSeatSearch();
        }
    }


    protected override async Task OnInitializedAsync()
    {
        halls = await Http.GetFromJsonAsync<List<HallDto>>("api/Halls") ?? new();
    }

    private async Task OnHallChanged(ChangeEventArgs e)
    {
        groupOptions.Clear();
        selectedSearchGroup = null;
        searchSeatRow = null;
        searchSeatNumber = null;
        filteredSeats.Clear();


        if (int.TryParse(e.Value?.ToString(), out var hallId))
        {
            selectedHallId = hallId;
            events = await Http.GetFromJsonAsync<List<EventDto>>($"api/events?hallId={hallId}") ?? new();
        }
        else
        {
            selectedHallId = null;
            events.Clear();
        }
    }

    private async Task OnEventChanged(ChangeEventArgs e)
    {
        selectedSeatIds.Clear();
        message = null;

        if (int.TryParse(e.Value?.ToString(), out var eventId))
        {
            selectedEventId = eventId;
            seats = await Http.GetFromJsonAsync<List<EventSeatDto>>($"api/reservations/seats?eventId={eventId}") ?? new();

            // build group dropdown
            groupOptions = seats
                .Select(s => s.GroupName)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(n => n)
                .ToList()!;

            // reset search + filtered list
            selectedSearchGroup = null;
            searchSeatRow = null;
            searchSeatNumber = null;
            ApplyFilters();


        }
        else
        {
            selectedEventId = null;
            seats.Clear();
        }
    }

    private void ToggleSeat(int hallSeatId, bool isChecked)
    {
        if (isChecked) selectedSeatIds.Add(hallSeatId);
        else selectedSeatIds.Remove(hallSeatId);
    }

    private async Task Reserve()
    {
        if (selectedEventId is null || selectedSeatIds.Count == 0) return;

        var payload = new
        {
            EventId = selectedEventId.Value,
            HallSeatIds = selectedSeatIds.ToList()
        };

        var res = await Http.PostAsJsonAsync("api/reservations", payload);
        var body = await res.Content.ReadAsStringAsync();

        message = res.IsSuccessStatusCode ? $"OK: {body}" : $"Klaida: {body}";

        // refresh seat list after reserve
        seats = await Http.GetFromJsonAsync<List<EventSeatDto>>($"api/reservations/seats?eventId={selectedEventId.Value}") ?? new();
        selectedSeatIds.Clear();
    }

    private void EvaluateSeatSearch()
    {
        searchResult = null;
        searchOk = false;

        if (selectedEventId is null)
        {
            searchResult = "Pirma pasirink renginį.";
            return;
        }

        if (string.IsNullOrWhiteSpace(seatSearch))
            return;

        var query = seatSearch.Trim();

        // Leidžiam 2 formatus:
        // 1) "12" (ShowSeatId)
        // 2) "VIP:12" (GroupName + ShowSeatId)
        string? group = null;
        int? showSeatId = null;

        if (query.Contains(':'))
        {
            var parts = query.Split(':', 2);
            group = parts[0].Trim();
            if (int.TryParse(parts[1].Trim(), out var id)) showSeatId = id;
        }
        else
        {
            if (int.TryParse(query, out var id)) showSeatId = id;
        }

        if (showSeatId is null)
        {
            searchResult = "Neteisingas formatas. Naudok pvz: 12 arba VIP:12";
            return;
        }

        var match = seats.FirstOrDefault(s =>
            s.ShowSeatId == showSeatId.Value &&
            (group is null || string.Equals(s.GroupName ?? "", group, StringComparison.OrdinalIgnoreCase)));

        if (match is null)
        {
            searchResult = "Tokia vieta nerasta šiame renginyje / salėje.";
            return;
        }

        if (match.IsReserved)
        {
            searchResult = $"Vieta {FormatSeat(match)} yra REZERVUOTA.";
            searchOk = false;
        }
        else
        {
            searchResult = $"Vieta {FormatSeat(match)} yra LAISVA.";
            searchOk = true;
        }
    }

    private static string FormatSeat(EventSeatDto s)
        => $"{s.GroupName}:{s.ShowSeatId} (HallSeatId={s.HallSeatId}, Color={s.Color})";

    private void OnGroupSearchChanged(ChangeEventArgs e)
    {
        selectedSearchGroup = string.IsNullOrWhiteSpace(e.Value?.ToString()) ? null : e.Value!.ToString();
        ApplyFilters();
    }

    private void OnRowSearchChanged(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString();
        searchSeatRow = int.TryParse(raw, out var r) ? r : null;
        ApplyFilters();
    }

    private void OnNumberSearchChanged(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString();
        searchSeatNumber = int.TryParse(raw, out var n) ? n : null;
        ApplyFilters();
    }

    private void ClearSearch()
    {
        selectedSearchGroup = null;
        searchSeatRow = null;
        searchSeatNumber = null;
        ApplyFilters();
    }
    private void ApplyFilters()
    {
        IEnumerable<EventSeatDto> query = seats;

        if (!string.IsNullOrWhiteSpace(selectedSearchGroup))
        {
            query = query.Where(s => string.Equals(s.GroupName, selectedSearchGroup, StringComparison.OrdinalIgnoreCase));
        }

        if (searchSeatRow is not null)
        {
            query = query.Where(s => s.SeatRow == searchSeatRow.Value);
        }

        if (searchSeatNumber is not null)
        {
            query = query.Where(s => s.SeatNumber == searchSeatNumber.Value);
        }

        filteredSeats = query.ToList();
    }


}
